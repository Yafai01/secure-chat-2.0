<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Secure Chat â€” Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:Inter,system-ui,Arial;background:#071025;color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
    .card{width:96%;max-width:800px;background:#071025;padding:18px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    header{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    input,button{padding:8px 10px;border-radius:8px;border:1px solid #234;background:#082b44;color:#e6eef8}
    #chat{height:360px;overflow:auto;border:1px solid #123;padding:10px;border-radius:8px;background:#031622;margin-bottom:8px}
    .msg{margin:6px 0}.mine{color:#8ee6a1}.theirs{color:#8fd4ff}.meta{font-size:11px;color:#9fb0c4}
    .controls{display:flex;gap:8px;margin-bottom:8px}
    @media(max-width:600px){.controls{flex-direction:column}}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <h2 style="margin:0">ðŸ”’ Secure Chat (Demo)</h2>
      <div style="margin-left:auto" class="meta">Server relay; browser does encryption</div>
    </header>

    <div class="controls">
      <input id="username" placeholder="Your name (e.g. Yafai)"/>
      <input id="passphrase" placeholder="Shared passphrase (both users use same)"/>
      <button id="btnConnect">Connect</button>
    </div>

    <div id="chat"></div>

    <div style="display:flex;gap:8px">
      <input id="message" placeholder="Type a message..." style="flex:1"/>
      <button id="btnSend">Send</button>
    </div>

    <p style="font-size:12px;color:#9fb0c4;margin-top:10px">
      Note: Demo uses passphrase-derived AES for simplicity. Production requires proper key exchange and per-message IVs.
    </p>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
    const chatEl = document.getElementById('chat');
    const usernameInput = document.getElementById('username');
    const passInput = document.getElementById('passphrase');
    const messageInput = document.getElementById('message');
    const btnConnect = document.getElementById('btnConnect');
    const btnSend = document.getElementById('btnSend');

    let socket = null;
    let username = '';
    let passphrase = '';

    function append(html, cls='') {
      const d = document.createElement('div'); d.className = 'msg ' + cls; d.innerHTML = html; chatEl.appendChild(d); chatEl.scrollTop = chatEl.scrollHeight;
    }

    function deriveKeyAndIv(pass) {
      const key = CryptoJS.SHA256(pass);
      const ivHex = CryptoJS.SHA256(pass + 'iv').toString(CryptoJS.enc.Hex).slice(0, 32);
      return { key, iv: CryptoJS.enc.Hex.parse(ivHex) };
    }

    function encryptMessage(plain, pass) {
      const { key, iv } = deriveKeyAndIv(pass);
      const cipher = CryptoJS.AES.encrypt(plain, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      return cipher.toString();
    }

    function decryptMessage(ciphertext, pass) {
      const { key, iv } = deriveKeyAndIv(pass);
      const bytes = CryptoJS.AES.decrypt(ciphertext, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      return bytes.toString(CryptoJS.enc.Utf8);
    }

    btnConnect.onclick = () => {
      username = usernameInput.value.trim() || 'Anonymous';
      passphrase = passInput.value;
      if (!passphrase) return alert('Enter a shared passphrase (both users must use same).');
      socket = io();
      socket.on('connect', () => append(`<span class="meta">Connected as <b>${username}</b> â€” socket ${socket.id}</span>`));
      socket.on('chat message', (cipher) => {
        try {
          const plain = decryptMessage(cipher, passphrase);
          if (!plain) throw new Error('empty after decrypt');
          append(`<span class="theirs"><b>${plain}</b></span>`);
        } catch (e) {
          append(`<span class="meta">Received encrypted message (failed to decrypt)</span>`);
        }
      });
      btnConnect.disabled = true; usernameInput.disabled = true; passInput.disabled = true;
    };

    btnSend.onclick = () => {
      if (!socket || !socket.connected) return alert('Connect first.');
      const text = messageInput.value.trim();
      if (!text) return;
      const payload = `${username}: ${text}`;
      const cipher = encryptMessage(payload, passphrase);
      append(`<span class="mine"><b>You:</b> ${payload}</span>`, 'mine');
      socket.emit('chat message', cipher);
      messageInput.value = '';
    };

    messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') btnSend.click(); });
  </script>
</body>
</html>
